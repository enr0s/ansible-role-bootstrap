---
# tasks file for bootstrap

- name: Upgrade distribution
  apt:
    state: latest
    update_cache: yes
    upgrade: dist
  register: upgrade_distribution
  retries: 5
  until: upgrade_distribution is succeeded

- name: Check if a reboot is needed
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file

- name: Reboot the box if kernel updated/installed
  reboot:
    msg: "Reboot initiated by Ansible for kernel updates"
    connect_timeout: 5
    pre_reboot_delay: 0
    post_reboot_delay: 30
    reboot_timeout: 600
    test_command: uptime
  when: reboot_required_file.stat.exists

- name: Wait 300 seconds for port 22 to become open and contain "OpenSSH"
  wait_for:
    delay: 10
    host: "{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}"
    port: 22
    search_regex: OpenSSH
  connection: local

- name: Set hostname
  hostname:
    name: "{{ hostname }}"
  notify:
    - restart systemd-logind

- name: Install bootstrap packages
  apt:
    name: "{{ item }}"
    state: present
  loop: "{{ bootstrap_packages }}"

- name: Set kernel parameters
  sysctl:
    name: "{{ item.name }}"
    sysctl_file: "{{ item.file | default(omit) }}"
    sysctl_set: yes
    state: present
    reload: yes
    value: "{{ item.value }}"
  loop: "{{ bootstrap_kernel_parameters }}"
